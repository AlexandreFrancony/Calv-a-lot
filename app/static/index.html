<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calv-a-lot | Follower Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêã</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-active { color: #22c55e; }
        .status-paused { color: #f59e0b; }
        .status-dead { color: #ef4444; }
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .period-btn { transition: all 0.15s; }
        .period-btn.active { background: #3b82f6; color: white; }
        .signal-executed { color: #22c55e; }
        .signal-skipped { color: #f59e0b; }
        .signal-error { color: #ef4444; }
        .signal-received { color: #60a5fa; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">

        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl md:text-3xl font-bold">Calv-a-lot</h1>
                <span id="mode-badge" class="px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider">--</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="status-badge" class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-800">--</span>
                <button id="toggle-btn" onclick="toggleAgent()" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm">
                    Pause/Resume
                </button>
            </div>
        </div>

        <!-- Budget + Leader Status Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-4">
                <p class="text-gray-400 text-xs uppercase tracking-wide">Total Value</p>
                <p id="total-value" class="text-2xl font-bold mt-1">--</p>
                <p id="pnl" class="text-sm mt-1">--</p>
                <p id="cash-usdt" class="text-xs text-gray-400 mt-1"></p>
                <p id="deposited-total" class="text-xs text-gray-500 mt-1"></p>
                <p id="withdrawn-total" class="text-xs text-gray-500 mt-1"></p>
                <div class="mt-2 flex gap-1">
                    <input id="deposit-input" type="number" step="0.01" min="0" placeholder="EUR"
                           class="w-20 px-2 py-1 text-xs bg-gray-700 border border-gray-600 rounded text-white">
                    <button onclick="doDeposit()" class="px-2 py-1 text-xs bg-blue-600 hover:bg-blue-500 rounded">Deposit</button>
                </div>
                <p id="deposit-status" class="text-xs mt-1 hidden"></p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <p class="text-gray-400 text-xs uppercase tracking-wide">Leader Status</p>
                <p id="leader-url" class="text-sm mt-1 text-blue-400 truncate">--</p>
                <p id="last-poll" class="text-sm mt-1 text-gray-400">Last poll: --</p>
                <p id="poll-interval" class="text-sm mt-1 text-gray-400">Interval: --</p>
                <p id="poll-status" class="text-xs mt-2 text-gray-500">--</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <p class="text-gray-400 text-xs uppercase tracking-wide">Signals Stats</p>
                <p id="signals-total" class="text-2xl font-bold mt-1">--</p>
                <p id="signals-executed" class="text-xs text-gray-400 mt-1">--</p>
                <p id="last-signal-time" class="text-xs text-gray-500 mt-1">--</p>
            </div>
        </div>

        <!-- Positions -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">Positions</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 text-left">
                            <th class="pb-2">Coin</th>
                            <th class="pb-2">Quantity</th>
                            <th class="pb-2">Avg Entry</th>
                            <th class="pb-2">Invested</th>
                            <th class="pb-2">Current Value</th>
                            <th class="pb-2">P&amp;L</th>
                        </tr>
                    </thead>
                    <tbody id="positions-table">
                        <tr><td colspan="6" class="py-2 text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Signaux re√ßus -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">Recent Signals</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 text-left">
                            <th class="pb-2">Time</th>
                            <th class="pb-2">Confidence</th>
                            <th class="pb-2">Actions</th>
                            <th class="pb-2">Status</th>
                            <th class="pb-2">Reasoning</th>
                        </tr>
                    </thead>
                    <tbody id="signals-table">
                        <tr><td colspan="5" class="py-2 text-gray-500">No signals yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">Recent Trades</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 text-left">
                            <th class="pb-2">Time</th>
                            <th class="pb-2">Coin</th>
                            <th class="pb-2">Action</th>
                            <th class="pb-2">Amount</th>
                            <th class="pb-2">Price</th>
                        </tr>
                    </thead>
                    <tbody id="trades-table">
                        <tr><td colspan="5" class="py-2 text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Withdrawals -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">Withdrawals</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 text-left">
                            <th class="pb-2">Time</th>
                            <th class="pb-2">Requested</th>
                            <th class="pb-2">Received</th>
                            <th class="pb-2">USDC sold</th>
                            <th class="pb-2">Status</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table">
                        <tr><td colspan="5" class="py-2 text-gray-500">No withdrawals yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Value Chart -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold">Portfolio Value Over Time</h2>
                <div class="flex gap-1">
                    <button class="period-btn px-3 py-1 rounded text-xs bg-gray-700 hover:bg-gray-600" data-period="1d">1J</button>
                    <button class="period-btn px-3 py-1 rounded text-xs bg-gray-700 hover:bg-gray-600 active" data-period="1w">1S</button>
                    <button class="period-btn px-3 py-1 rounded text-xs bg-gray-700 hover:bg-gray-600" data-period="1m">1M</button>
                    <button class="period-btn px-3 py-1 rounded text-xs bg-gray-700 hover:bg-gray-600" data-period="1y">1A</button>
                </div>
            </div>
            <div id="chart-container" style="width:100%; position:relative;">
                <canvas id="value-chart"></canvas>
            </div>
        </div>

        <p class="text-center text-gray-600 text-xs">Calv-a-lot v1.0 | Follower | Auto-refresh 30s</p>
    </div>

    <script>
    let currentPrices = {};
    let currentPeriod = '1w';

    // Ic√¥nes crypto via CoinCap CDN
    function coinIcon(symbol) {
        var s = symbol.replace('USDC','').replace('USDT','').toLowerCase();
        return '<img src="https://assets.coincap.io/assets/icons/' + s + '@2x.png" alt="' + s + '" class="w-5 h-5 inline-block rounded-full mr-1.5 align-middle" onerror="this.style.display=\'none\'">';
    }

    async function fetchJSON(url) {
        try {
            var res = await fetch(url);
            if (!res.ok) throw new Error(res.statusText);
            return await res.json();
        } catch (e) {
            console.error('Fetch error:', url, e);
            return null;
        }
    }

    async function updateBudget() {
        var b = await fetchJSON('/api/budget');
        if (!b) return;

        var badge = document.getElementById('status-badge');
        badge.textContent = b.status || '--';
        badge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-gray-800 status-' + (b.status || '').toLowerCase();

        if (b.status === 'UNINITIALIZED') return;

        // Total Value
        if (b.total_value_eur !== undefined) {
            var valEur = b.total_value_eur.toFixed(2) + '\u20AC';
            var valUsd = b.total_value_usdt !== undefined ? ' / $' + b.total_value_usdt.toFixed(2) : '';
            document.getElementById('total-value').textContent = valEur + valUsd;
            var depositedEur = b.total_deposited_eur || b.initial_total_eur || 100;
            var pnlEur = b.total_value_eur - depositedEur;
            var pnlPct = depositedEur > 0 ? (pnlEur / depositedEur * 100) : 0;
            var pnlEl = document.getElementById('pnl');
            pnlEl.textContent = (pnlEur >= 0 ? '+' : '') + pnlEur.toFixed(2) + '\u20AC (' + (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(1) + '%)';
            pnlEl.className = 'text-sm mt-1 ' + (pnlEur >= 0 ? 'positive' : 'negative');
        }
        if (b.cash_usdt !== undefined) {
            document.getElementById('cash-usdt').textContent = 'Cash: $' + b.cash_usdt.toFixed(2) + ' USDC';
        }
        var depEl = document.getElementById('deposited-total');
        var deposited = b.total_deposited_eur || b.initial_total_eur || 0;
        if (deposited > 0) {
            depEl.textContent = 'Invested: ' + deposited.toFixed(2) + '\u20AC';
        }
    }

    async function updateAgent() {
        var a = await fetchJSON('/api/agent/status');
        if (!a) return;

        // Mode badge
        var modeBadge = document.getElementById('mode-badge');
        if (a.leader_url && a.leader_url.includes('francony')) {
            modeBadge.textContent = a.paused ? 'PAUSED' : 'FOLLOWING';
            modeBadge.className = 'px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider ' +
                (a.paused ? 'bg-yellow-600 text-white' : 'bg-emerald-600 text-white');
        }

        // Leader info
        document.getElementById('leader-url').textContent = a.leader_url || '--';
        document.getElementById('poll-interval').textContent = 'Interval: ' + (a.poll_interval_seconds || '--') + 's';

        if (a.last_poll_time) {
            document.getElementById('last-poll').textContent = 'Last poll: ' + new Date(a.last_poll_time * 1000).toLocaleTimeString();
        }

        if (a.last_poll) {
            document.getElementById('poll-status').textContent = 'Status: ' + (a.last_poll.status || '--');
        }

        var btn = document.getElementById('toggle-btn');
        btn.textContent = a.paused ? 'Resume' : 'Pause';
    }

    async function updatePositions() {
        var positions = await fetchJSON('/api/positions');
        if (!positions) return;

        var tbody = document.getElementById('positions-table');
        var active = positions.filter(function(p) { return p.quantity > 0; });

        if (active.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="py-2 text-gray-500">No open positions</td></tr>';
            return;
        }

        tbody.innerHTML = active.map(function(p) {
            var price = currentPrices[p.coin] || 0;
            var value = p.quantity * price;
            var pnl = value - p.total_invested_usdt;
            var pnlPct = p.total_invested_usdt > 0 ? (pnl / p.total_invested_usdt * 100) : 0;
            return '<tr class="border-t border-gray-700">' +
                '<td class="py-2 font-semibold">' + coinIcon(p.coin) + p.coin.replace('USDC','') + '</td>' +
                '<td class="py-2">' + p.quantity.toFixed(6) + '</td>' +
                '<td class="py-2">$' + p.avg_entry_price.toFixed(2) + '</td>' +
                '<td class="py-2">$' + p.total_invested_usdt.toFixed(2) + '</td>' +
                '<td class="py-2">$' + value.toFixed(2) + '</td>' +
                '<td class="py-2 ' + (pnl >= 0 ? 'positive' : 'negative') + '">' + (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2) + ' (' + (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(1) + '%)</td>' +
                '</tr>';
        }).join('');
    }

    async function updateSignals() {
        var signals = await fetchJSON('/api/signals?limit=10');
        if (!signals) return;

        // Stats
        document.getElementById('signals-total').textContent = signals.length + ' signal(s)';
        var executed = signals.filter(function(s) { return s.status === 'executed'; }).length;
        document.getElementById('signals-executed').textContent = executed + ' executed, ' + (signals.length - executed) + ' other';

        if (signals.length > 0) {
            document.getElementById('last-signal-time').textContent = 'Last: ' + new Date(signals[0].received_at).toLocaleString();
        }

        var tbody = document.getElementById('signals-table');
        if (signals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-2 text-gray-500">No signals yet</td></tr>';
            return;
        }

        tbody.innerHTML = signals.map(function(s) {
            var time = s.received_at ? new Date(s.received_at).toLocaleString() : '--';
            var conf = s.confidence ? (s.confidence * 100).toFixed(0) + '%' : '--';
            var actions = (s.actions || []).filter(function(a) { return a.action !== 'HOLD'; });
            var actionStr = actions.length > 0
                ? actions.map(function(a) {
                    var cls = a.action === 'BUY' ? 'text-green-400' : 'text-red-400';
                    return '<span class="' + cls + '">' + a.action + ' ' + a.coin.replace('USDC','') + '</span>';
                }).join(', ')
                : '<span class="text-gray-500">HOLD</span>';
            var reasoning = (s.reasoning || '').substring(0, 60);
            return '<tr class="border-t border-gray-700">' +
                '<td class="py-2 text-xs">' + time + '</td>' +
                '<td class="py-2">' + conf + '</td>' +
                '<td class="py-2 text-xs">' + actionStr + '</td>' +
                '<td class="py-2 text-xs signal-' + s.status + '">' + s.status + '</td>' +
                '<td class="py-2 text-xs text-gray-400">' + reasoning + '</td>' +
                '</tr>';
        }).join('');
    }

    async function updateTrades() {
        var trades = await fetchJSON('/api/trades?limit=10');
        if (!trades) return;

        // Extraire les prix des positions pour les calculs
        var positions = await fetchJSON('/api/positions');
        if (positions) {
            // Pas de market endpoint ici, on utilise les prix depuis les derniers trades
        }

        var tbody = document.getElementById('trades-table');
        if (trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-2 text-gray-500">No trades yet</td></tr>';
            return;
        }

        tbody.innerHTML = trades.map(function(t) {
            var time = t.created_at ? new Date(t.created_at).toLocaleString() : '--';
            var actionClass = t.action === 'BUY' ? 'text-green-400' : 'text-red-400';
            var simBadge = t.is_simulated ? ' <span class="text-xs text-gray-500">[SIM]</span>' : '';
            return '<tr class="border-t border-gray-700">' +
                '<td class="py-2 text-xs">' + time + '</td>' +
                '<td class="py-2 font-semibold">' + coinIcon(t.coin) + t.coin.replace('USDC','') + '</td>' +
                '<td class="py-2 ' + actionClass + '">' + t.action + simBadge + '</td>' +
                '<td class="py-2">$' + Number(t.amount_usdt).toFixed(2) + '</td>' +
                '<td class="py-2">$' + Number(t.price).toFixed(2) + '</td>' +
                '</tr>';
        }).join('');
    }

    async function updateWithdrawals() {
        var data = await fetchJSON('/api/budget/withdrawals');
        if (!data) return;

        var totalEl = document.getElementById('withdrawn-total');
        if (data.total_eur > 0) {
            totalEl.textContent = 'Withdrawn: ' + data.total_eur.toFixed(2) + '\u20AC';
        } else {
            totalEl.textContent = '';
        }

        var tbody = document.getElementById('withdrawals-table');
        if (!data.withdrawals || data.withdrawals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-2 text-gray-500">No withdrawals yet</td></tr>';
            return;
        }
        tbody.innerHTML = data.withdrawals.map(function(w) {
            var time = w.created_at ? new Date(w.created_at).toLocaleString() : '--';
            return '<tr class="border-t border-gray-700">' +
                '<td class="py-2 text-xs">' + time + '</td>' +
                '<td class="py-2">' + (w.amount_eur_requested || 0).toFixed(2) + '\u20AC</td>' +
                '<td class="py-2 text-emerald-400">' + (w.amount_eur_received || 0).toFixed(2) + '\u20AC</td>' +
                '<td class="py-2 text-gray-300">$' + (w.amount_usdt_sold || 0).toFixed(2) + '</td>' +
                '<td class="py-2 text-xs">' + (w.status || 'completed') + '</td>' +
                '</tr>';
        }).join('');
    }

    function formatChartDate(dateStr, period) {
        var d = new Date(dateStr);
        if (period === '1d') return d.toLocaleTimeString('fr', { hour: '2-digit', minute: '2-digit' });
        if (period === '1w') return d.toLocaleDateString('fr', { day: '2-digit', month: '2-digit' }) + ' ' + d.toLocaleTimeString('fr', { hour: '2-digit', minute: '2-digit' });
        return d.toLocaleDateString('fr', { day: '2-digit', month: '2-digit' });
    }

    async function updateChart() {
        var snapshots = await fetchJSON('/api/budget/history?period=' + currentPeriod);
        if (!snapshots || snapshots.length < 2) return;

        var container = document.getElementById('chart-container');
        var canvas = document.getElementById('value-chart');
        var dpr = window.devicePixelRatio || 1;
        var isMobile = window.innerWidth < 768;
        var chartHeight = isMobile ? 200 : 300;

        canvas.style.width = '100%';
        canvas.style.height = chartHeight + 'px';
        canvas.width = container.offsetWidth * dpr;
        canvas.height = chartHeight * dpr;

        var ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);

        var w = container.offsetWidth;
        var h = chartHeight;
        var pad = { top: 20, right: 15, bottom: 35, left: isMobile ? 50 : 60 };

        var data = snapshots.slice().reverse();
        var values = data.map(function(s) { return s.total_value_eur; });
        var min = Math.min.apply(null, values) * 0.95;
        var max = Math.max.apply(null, values) * 1.05;
        if (min === max) { min -= 1; max += 1; }
        var chartW = w - pad.left - pad.right;
        var chartH = h - pad.top - pad.bottom;

        ctx.clearRect(0, 0, w, h);

        // Grille
        ctx.strokeStyle = '#374151';
        ctx.lineWidth = 0.5;
        var gridLines = isMobile ? 3 : 5;
        for (var i = 0; i <= gridLines; i++) {
            var y = pad.top + chartH * (1 - i / gridLines);
            ctx.beginPath();
            ctx.moveTo(pad.left, y);
            ctx.lineTo(w - pad.right, y);
            ctx.stroke();
            var val = min + (max - min) * (i / gridLines);
            ctx.fillStyle = '#9ca3af';
            ctx.font = (isMobile ? '10' : '11') + 'px monospace';
            ctx.textAlign = 'right';
            ctx.fillText(val.toFixed(1) + '\u20AC', pad.left - 5, y + 4);
        }

        // Ligne
        ctx.beginPath();
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 2;
        for (var j = 0; j < data.length; j++) {
            var x = pad.left + (j / (data.length - 1)) * chartW;
            var yy = pad.top + chartH - ((values[j] - min) / (max - min)) * chartH;
            if (j === 0) ctx.moveTo(x, yy);
            else ctx.lineTo(x, yy);
        }
        ctx.stroke();

        // Remplissage
        ctx.lineTo(pad.left + chartW, pad.top + chartH);
        ctx.lineTo(pad.left, pad.top + chartH);
        ctx.closePath();
        var grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + chartH);
        grad.addColorStop(0, 'rgba(34, 197, 94, 0.15)');
        grad.addColorStop(1, 'rgba(34, 197, 94, 0)');
        ctx.fillStyle = grad;
        ctx.fill();

        // Labels X
        ctx.fillStyle = '#9ca3af';
        ctx.font = (isMobile ? '9' : '10') + 'px monospace';
        ctx.textAlign = 'center';
        var labelCount = isMobile ? 4 : 6;
        labelCount = Math.min(labelCount, data.length);
        for (var k = 0; k < labelCount; k++) {
            var idx = Math.floor(k / (labelCount - 1) * (data.length - 1));
            var lx = pad.left + (idx / (data.length - 1)) * chartW;
            ctx.fillText(formatChartDate(data[idx].created_at, currentPeriod), lx, h - 5);
        }
    }

    // S√©lecteur de p√©riode
    document.querySelectorAll('.period-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentPeriod = btn.dataset.period;
            updateChart();
        });
    });

    var resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(updateChart, 200);
    });

    async function toggleAgent() {
        await fetch('/api/agent/toggle', { method: 'POST' });
        setTimeout(updateAgent, 500);
    }

    async function doDeposit() {
        var input = document.getElementById('deposit-input');
        var statusEl = document.getElementById('deposit-status');
        var amount = parseFloat(input.value);
        if (isNaN(amount) || amount <= 0) return;
        if (!confirm('Ajouter ' + amount.toFixed(2) + ' EUR comme d\u00e9p\u00f4t ?')) return;

        statusEl.textContent = 'Enregistrement...';
        statusEl.className = 'text-xs mt-1 text-yellow-400';

        try {
            var res = await fetch('/api/budget/deposit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({amount_eur: amount})
            });
            var data = await res.json();
            if (res.ok) {
                input.value = '';
                statusEl.textContent = 'D\u00e9p\u00f4t enregistr\u00e9 : total ' + data.total_deposited_eur.toFixed(2) + '\u20AC';
                statusEl.className = 'text-xs mt-1 text-blue-400';
                refreshAll();
            } else {
                statusEl.textContent = data.error || 'Erreur';
                statusEl.className = 'text-xs mt-1 text-red-400';
            }
        } catch (e) {
            statusEl.textContent = 'Erreur r\u00e9seau';
            statusEl.className = 'text-xs mt-1 text-red-400';
        }
        setTimeout(function() { statusEl.className = 'text-xs mt-1 hidden'; }, 10000);
    }

    async function updatePrices() {
        var prices = await fetchJSON('/api/prices');
        if (prices) currentPrices = prices;
    }

    async function refreshAll() {
        await Promise.all([updateBudget(), updateAgent(), updateSignals(), updateWithdrawals(), updatePrices()]);
        await updatePositions();
        await updateTrades();
        await updateChart();
    }

    refreshAll();
    setInterval(refreshAll, 30000);
    </script>
</body>
</html>
